# Microsoft Entra Verified ID Integration Setup

## Prerequisites

1. **Azure Subscription** with access to Microsoft Entra ID
2. **Microsoft Entra Verified ID** service enabled in your tenant
3. **App Registration** in Azure AD with appropriate permissions

## Configuration Steps

### 1. Create App Registration in Azure AD

1. Go to **Azure Portal** → **Azure Active Directory** → **App registrations**
2. Click **New registration**
3. Configure:
   - **Name**: `Contoso Finance Portal Verifier`
   - **Supported account types**: `Accounts in this organizational directory only`
   - **Redirect URI**: Not needed for this scenario
4. Click **Register**

### 2. Configure App Permissions

1. Go to **API permissions** in your app registration
2. Click **Add a permission**
3. Select **APIs my organization uses**
4. Search for **"Verifiable Credentials Service Request"** or use App ID: `3db474b9-6a0c-4840-96ac-1fceb342124f`
5. Choose **Application permissions**
6. Add: `VerifiableCredential.Create.All`
7. Alternatively, you can also add: `bbb94529-53a3-4be5-a069-7eaf2712b826/.default`
8. Click **Grant admin consent**

### 3. Create Client Secret

1. Go to **Certificates & secrets**
2. Click **New client secret**
3. Configure:
   - **Description**: `Contoso Finance Portal Secret`
   - **Expires**: Choose appropriate duration
4. **Copy the secret value immediately** (you won't see it again)

### 4. Set Up Verified ID Service

1. Go to **Azure Portal** → **Microsoft Entra ID** → **Verified ID**
2. Complete the initial setup if not done already
3. Configure your **Verifier** settings
4. Note your **DID (Decentralized Identifier)**

### 5. Configure Environment Variables

1. Copy `.env.example` to `.env`
2. Update the following values:

```bash
# Your Azure AD tenant ID (from Overview page)
TENANT_ID=your-actual-tenant-id

# App registration details
CLIENT_ID=your-app-client-id
CLIENT_SECRET=your-app-client-secret

# Verified ID configuration
VERIFIER_AUTHORITY=your-did-identifier
ISSUER_AUTHORITY=your-did-identifier
CREDENTIAL_TYPE=YourCredentialType
```

### 6. Make Your Local Development Server Public (Required)

**Microsoft Entra Verified ID requires a publicly accessible callback URL.** Your local `http://localhost:5000` won't work.

#### Option A: Using ngrok (Recommended for Development)

1. **Install ngrok**: Download from https://ngrok.com/
2. **Start your application**: `npm run dev`
3. **In a new terminal, expose port 5000**: 
   ```bash
   ngrok http 5000
   ```
4. **Copy the HTTPS URL** (e.g., `https://abc123.ngrok.io`)
5. **Update your .env file**:
   ```bash
   BASE_URL=https://abc123.ngrok.io
   ```
6. **Restart your application** to load the new URL

#### Option B: Using localtunnel

1. **Install localtunnel**: `npm install -g localtunnel`
2. **Expose port 5000**: `lt --port 5000`
3. **Update BASE_URL** with the provided URL

#### Option C: Deploy to Cloud (Production)

- Deploy to Azure App Service, Heroku, or similar
- Use the production URL as your BASE_URL

### 7. Test the Integration

1. Restart your application: `npm run dev`
2. Create a transaction over $50,000
3. The QR code should now be generated by Microsoft Entra Verified ID
4. Scan with Microsoft Authenticator to complete verification

## Important Notes

- **Development Mode**: The app includes fallback to mock QR codes if the service is unavailable
- **Production**: Remove the fallback logic and handle errors appropriately
- **Credentials**: Ensure you have appropriate Verified ID credentials issued to test users
- **Webhook**: The callback URL must be accessible from Microsoft's servers (use ngrok for local testing)

## Troubleshooting

- **401 Errors**: Check client ID/secret and tenant ID
- **QR Code Issues**: Verify the DID authority and credential type
- **Callback Issues**: Ensure webhook URL is publicly accessible
- **Mock Fallback**: Check console logs if using development fallback

## Security Considerations

- Store secrets securely (Azure Key Vault recommended for production)
- Use HTTPS for all webhook callbacks
- Validate webhook signatures in production
- Implement proper error handling and logging
